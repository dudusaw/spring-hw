<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa"
            crossorigin="anonymous"></script>
</head>
<body>
<div th:insert="~{header :: header}"></div>
<div class="d-flex">
    <div th:insert="~{navbar :: navbar}"></div>
    <div class="flex-grow-1 me-4">
        <h1>Admin panel</h1>
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button"
                        role="tab">Users table
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button"
                        role="tab">New user
                </button>
            </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">
            <div class="tab-pane active" id="home" role="tabpanel" tabindex="0">
                <div class="card w-100">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <h3>All users</h3>
                        </li>
                        <li class="list-group-item">
                            <table class="table">
                                <thead>
                                <tr>
                                    <th scope="col">Id</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Email</th>
                                    <th scope="col">Role</th>
                                    <th scope="col">Edit</th>
                                    <th scope="col">Delete</th>
                                </tr>
                                </thead>
                                <tbody id="tableBody">
<!--                                <tr>-->
<!--                                    <th scope="row">1</th>-->
<!--                                    <td th:text="*{name}">Mark</td>-->
<!--                                    <td th:text="*{email}">Otto</td>-->
<!--                                    <td th:text="*{roles}">Otto</td>-->
<!--                                    <td>-->
<!--                                        <button type="button" class="btn btn-info" th:onclick="|setModalData(*{id})|"-->
<!--                                                data-bs-toggle="modal" data-bs-target="#edit-modal">Edit</button>-->
<!--                                    </td>-->
<!--                                    <td>-->
<!--                                        <button type="button" class="btn btn-danger" th:onclick="|setModalDeleteData(*{id})|"-->
<!--                                                data-bs-toggle="modal" data-bs-target="#delete-modal">Delete</button>-->
<!--                                    </td>-->
<!--                                </tr>-->
                                </tbody>
                            </table>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="tab-pane" id="profile" role="tabpanel" tabindex="0">
                <div class="card w-100">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <h3>Add new user</h3>
                        </li>
                        <li class="list-group-item">
                            <form id="userForm" method="post">
                                <div class="mb-3">
                                    <label for="nameInput1" class="form-label">Name</label>
                                    <input type="text" class="form-control" id="nameInput1" name="name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="exampleInputEmail1" class="form-label">Email address</label>
                                    <input type="email" class="form-control" id="exampleInputEmail1" name="email"
                                           required>
                                </div>
                                <div class="mb-3">
                                    <label for="exampleInputPassword1" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="exampleInputPassword1"
                                           name="password" required>
                                </div>
                                <div class="mb-3">
                                    <label for="selectInput">Role</label>
                                    <select id="selectInput" class="form-select" multiple name="roles" required>
                                        <option value="ROLE_USER" selected>User</option>
                                        <option value="ROLE_ADMIN">Admin</option>
                                    </select>
                                </div>
                                <button id="addNewUserButton" type="button" class="btn btn-success">Add new user
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="modal fade" id="edit-modal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit user</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="userFormModal" method="post">
                                <div class="mb-3">
                                    <label for="idModal" class="form-label">Id</label>
                                    <input type="number" class="form-control" id="idModal" name="id" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="nameInputModal" class="form-label">Name</label>
                                    <input type="text" class="form-control" id="nameInputModal" name="name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="inputEmailModal" class="form-label">Email address</label>
                                    <input type="email" class="form-control" id="inputEmailModal" name="email"
                                           required>
                                </div>
                                <div class="mb-3">
                                    <label for="exampleInputPasswordModal" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="exampleInputPasswordModal"
                                           name="password" required>
                                </div>
                                <div class="mb-3">
                                    <label for="selectInputModal">Role</label>
                                    <select id="selectInputModal" class="form-select" multiple name="roles" required>
                                        <option value="ROLE_USER" selected>User</option>
                                        <option value="ROLE_ADMIN">Admin</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button id="editUserButton" type="button" class="btn btn-primary">Edit</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="delete-modal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Delete user</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="userFormDeleteModal" method="post">
                                <div class="mb-3">
                                    <label for="idModalDelete" class="form-label">Id</label>
                                    <input type="text" class="form-control" id="idModalDelete" name="id" disabled>
                                </div>
                                <div class="mb-3">
                                    <label for="nameInputModalDelete" class="form-label">Name</label>
                                    <input type="text" class="form-control" id="nameInputModalDelete" name="name" disabled>
                                </div>
                                <div class="mb-3">
                                    <label for="inputEmailModalDelete" class="form-label">Email address</label>
                                    <input type="email" class="form-control" id="inputEmailModalDelete" name="email"
                                           disabled>
                                </div>
                                <div class="mb-3">
                                    <label for="selectInputModalDelete">Role</label>
                                    <select id="selectInputModalDelete" class="form-select" multiple name="roles" disabled>
                                        <option value="ROLE_USER">User</option>
                                        <option value="ROLE_ADMIN">Admin</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button id="deleteUserButton" type="button" class="btn btn-danger">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="module">
    import * as bootstrap from 'https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js'
    document.getElementById('addNewUserButton').addEventListener('click', newUserRequest);
    document.getElementById('deleteUserButton').addEventListener('click', deleteUser);
    document.getElementById('editUserButton').addEventListener('click', editUser);

    function newUserRequest() {
        let form = document.getElementById('userForm');
        if (form.reportValidity()) {
            fetch('/admin/users', {
                method: 'POST',
                credentials: 'include',
                body: new FormData(form),
            }).then(_ => {
                updateTable();
            });
        }
    }

    function updateTable() {
        let tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';
        fetch(`/admin/users/`, {
            method: 'GET',
            credentials: 'include',
        }).then(res => {
            res.json().then(users => {
                for (let usr of users) {
                    let tr = document.createElement('tr');
                    tr.innerHTML = `<th scope="row">${usr.id}</th>
                                    <td>${usr.name}</td>
                                    <td>${usr.email}</td>
                                    <td>${usr.roles.map(o => o.authority)}</td>
                                    <td>
                                        <button id="editModalButton${usr.id}" type="button" class="btn btn-info"
                                                data-bs-toggle="modal" data-bs-target="#edit-modal">Edit</button>
                                    </td>
                                    <td>
                                        <button id="deleteModalButton${usr.id}" type="button" class="btn btn-danger"
                                                data-bs-toggle="modal" data-bs-target="#delete-modal">Delete</button>
                                    </td>`;
                    tableBody.appendChild(tr);
                    tr.querySelector('#editModalButton' + usr.id).addEventListener('click', () => setModalData(usr.id));
                    tr.querySelector('#deleteModalButton' + usr.id).addEventListener('click', () => setModalDeleteData(usr.id));
                }
            })
        });
    }
    updateTable();

    function deleteUser() {
        let form = document.getElementById('userFormDeleteModal');
        let id = document.getElementById('idModalDelete').value;
        if (form.reportValidity()) {
            fetch(`/admin/users/${id}`, {
                method: 'DELETE',
                credentials: 'include',
            }).then(_ => {
                updateTable();
            });
        }
    }

    function editUser() {
        let form = document.getElementById('userFormModal');
        let formData = new FormData(form);
        if (form.reportValidity()) {
            fetch(`/admin/users/`, {
                method: 'PUT',
                credentials: 'include',
                body: formData,
            }).then(_ => {
                updateTable();
            });
        }
    }

    function setModalData(userId) {
        fetch(`/admin/users/${userId}`, {
            method: 'GET',
            credentials: 'include',
        }).then(res => {
            res.json().then(usr => {
                let idModal = document.getElementById('idModal');
                let nameModal = document.getElementById('nameInputModal');
                let emailModal = document.getElementById('inputEmailModal');
                idModal.value = usr.id;
                nameModal.value = usr.name;
                emailModal.value = usr.email;
            })
        })
    }

    function setModalDeleteData(userId) {
        fetch(`/admin/users/${userId}`, {
            method: 'GET',
            credentials: 'include',
        }).then(res => {
            res.json().then(usr => {
                let idModal = document.getElementById('idModalDelete');
                let nameModal = document.getElementById('nameInputModalDelete');
                let emailModal = document.getElementById('inputEmailModalDelete');
                idModal.value = usr.id;
                nameModal.value = usr.name;
                emailModal.value = usr.email;
            })
        })
    }
</script>
</body>
</html>